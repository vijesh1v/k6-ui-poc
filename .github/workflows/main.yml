name: k6 UI Browser Test

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  k6-ui-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create results directories
        run: |
          mkdir -p k6/results
          mkdir -p k6/tests/screenshots

      - name: Setup k6 with browser support
        uses: grafana/setup-k6-action@v1
        with:
          browser: true

      - name: Run k6 UI browser test
        uses: grafana/run-k6-action@v1
        env:
          BASE_URL: https://example.com/
        with:
          path: |
            k6/tests/ui-demo_test.js
          flags: |
            --out json=k6/results/ui-demo-results.json

      # ⭐ Convert HTML summary → PDF
      - name: Convert HTML report to PDF
        uses: narthanaj/html-to-pdf-action@v1
        with:
          source: k6/results/ui-summary.html
          output: k6/results/ui-summary.pdf

      # Keep artifacts (HTML, PDF, screenshots)
      - name: Upload k6 results artifact
        uses: actions/upload-artifact@v4
        with:
          name: k6-ui-results
          path: |
            k6/results/
            k6/tests/screenshots/

      # ⭐ Send PDF to client via email
      - name: Send k6 report via email
        uses: dawidd6/action-send-mail@v6
        with:
          # EITHER use a single connection URL secret (recommended)...
          # connection_url: ${{ secrets.MAIL_CONNECTION }}

          # ...OR configure SMTP manually (example: Gmail SMTP using app password):
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USERNAME }}      # your SMTP username
          password: ${{ secrets.MAIL_PASSWORD }}      # your SMTP/app password

          subject: "k6 UI Test Report"
          from: "k6 Bot <no-reply@example.com>"
          to: "vijeshv.in@gmail.com"

          body: |
            Hi,

            Please find attached the latest k6 UI test report (PDF).
            This report was generated automatically from the GitHub Actions pipeline.

            Regards,
            k6 Automation

          # Attach the generated PDF
          attachments: |
            k6/results/ui-summary.pdf
